library 'aws-access-keys@master'


repositoryUrl="git@github.com:PerfectoCode/reporting-java-sdk.git"

pipeline {
    agent { label 'ubuntu-build-slave' }
    parameters {
        string(name: 'RELEASE_VERSION', defaultValue: '1.1.11', description: '<strong>Optional parameter</strong> for using a custom value for the released artifacts.<p>If empty then the value used is generated by stripping "-SNAPSHOT" from reporting-sdk\\pom.xml version')
        string(name: 'BranchName', defaultValue: 'master', description: '')
    }

    options {
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20'))
    }
    stages {
        stage('CLEAN UP') {
            steps {
                cleanWs()
            }
        }

        stage('SCM CHECKOUT environments') {

            steps {
                script {
                 dir("$WORKSPACE/source") {
                    git branch: "${BranchName}", changelog: false, credentialsId: '4f48b2f0-6fcf-4cde-baa7-6d04d45f270c', poll: false, shallow: true, url: repositoryUrl
                }
            }
        }
    }

    stage('build') {
      steps {
        script {
            echo "compile"
            dir("$WORKSPACE/source") {
                withMaven(
                    maven: 'Maven latest',
                    mavenOpts: '-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/temp/dump.hprof',
                    mavenLocalRepo: '/home/ubuntu/.m2/repository') {
                    sh(script: "mvn --batch-mode release:prepare release:perform -DreleaseVersion=${RELEASE_VERSION} -DdevelopmentVersion=1.0-SNAPSHOT -X"  );
                }
            }
        }
    }
   }
}

post {
  failure  {
      script {
          currentBuild.result = 'FAILURE'
          emailext subject: '$DEFAULT_SUBJECT',
          body: '$DEFAULT_CONTENT',
          recipientProviders: [
          [$class: 'CulpritsRecipientProvider'],
          [$class: 'DevelopersRecipientProvider'],
          [$class: 'RequesterRecipientProvider']
          ],
          replyTo: '$DEFAULT_REPLYTO',
          to: 'bmikler@perforce.com;'
      }
  }
}
}
